#!/Users/yoshihide/dotfiles-mac/scripts/.venv/bin/python3
import os
import sys
import subprocess
import argparse
import math

# å¿…é ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒã‚§ãƒƒã‚¯
try:
    import inquirer
except ImportError:
    print("\033[31m[ERROR] 'inquirer' ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¿…è¦ã§ã™ã€‚\033[0m")
    print("å®Ÿè¡Œã—ã¦ãã ã•ã„: pip install inquirer")
    sys.exit(1)

# --- è¨­å®š ---
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
PDF2JOHN_PATH = os.path.join(BASE_DIR, "john", "src", "pdf2john.py")
WORDLIST_PATH = os.path.join(BASE_DIR, "john", "wordlists", "rockyou.txt")
PYTHON_BIN = sys.executable
HASH_FILE = "target_hash.txt"

# --- è‰²è¨­å®š ---
GREEN = '\033[0;32m'
CYAN = '\033[0;36m'
YELLOW = '\033[1;33m'
RED = '\033[0;31m'
NC = '\033[0m'

# --- ãƒ­ã‚°å‡ºåŠ›é–¢æ•° ---
def print_step(msg):
    print(f"\n{YELLOW}[*] {msg}{NC}")

def print_success(msg):
    print(f"{GREEN}[OK] {msg}{NC}")

def print_error(msg):
    print(f"{RED}[ã‚¨ãƒ©ãƒ¼] {msg}{NC}")

def print_warning(msg):
    print(f"{YELLOW}[è­¦å‘Š] {msg}{NC}")

# --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
def get_rule_path():
    """ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’è‡ªå‹•æ¢ç´¢ã™ã‚‹"""
    candidates = [
        "/opt/homebrew/opt/hashcat/share/doc/hashcat/rules/best66.rule",
        "/opt/homebrew/share/hashcat/rules/best64.rule",
        "/usr/local/share/hashcat/rules/best64.rule",
        os.path.join(BASE_DIR, "john", "rules", "best64.rule")
    ]
    for path in candidates:
        if os.path.exists(path): return path
    return None

# --- å®‰å…¨ãªå…¥åŠ›é–¢æ•° (inquirer.Textã®ä»£ã‚ã‚Š) ---
def safe_input(prompt_text, validator=None):
    """ç”»é¢å´©ã‚Œã‚’é˜²ããŸã‚æ¨™æº–ã®inputã‚’ä½¿ç”¨"""
    while True:
        try:
            val = input(f"{YELLOW}[?] {prompt_text}{NC}").strip()
            if not val: # ç©ºã‚¨ãƒ³ã‚¿ãƒ¼å¯¾ç­–
                print(f"{RED}    å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„{NC}")
                continue
            
            if validator:
                error_msg = validator(val)
                if error_msg:
                    print(f"{RED}    {error_msg}{NC}")
                    continue
            return val
        except KeyboardInterrupt:
            print("\nä¸­æ–­ã—ã¾ã—ãŸ")
            sys.exit(0)

def check_digits(val):
    if not val.isdigit() or int(val) <= 0:
        return "1ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
    return None

# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
def main():
    parser = argparse.ArgumentParser(description="PDF Password Cracker Wizard")
    parser.add_argument("pdf_file", nargs='?', help="è§£æå¯¾è±¡ã®PDFãƒ•ã‚¡ã‚¤ãƒ«")
    args = parser.parse_args()

    target_pdf = args.pdf_file
    if not target_pdf:
        # ãƒ‘ã‚¹å…¥åŠ›ã‚‚æ¨™æº–inputã«å¤‰æ›´
        try:
            target_pdf = input(f"{CYAN}è§£æå¯¾è±¡ã®PDFãƒ‘ã‚¹ã‚’å…¥åŠ› > {NC}").strip().replace("'", "").replace('"', '')
        except KeyboardInterrupt: sys.exit()
    
    if not target_pdf or not os.path.exists(target_pdf):
        print_error(f"ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {target_pdf}"); sys.exit(1)

    # 1. ãƒãƒƒã‚·ãƒ¥æŠ½å‡º
    print_step("PDFã‹ã‚‰ãƒãƒƒã‚·ãƒ¥æƒ…å ±ã‚’æŠ½å‡ºä¸­...")
    try:
        if not os.path.exists(PDF2JOHN_PATH):
            print_error(f"pdf2johnãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {PDF2JOHN_PATH}"); sys.exit(1)

        result = subprocess.run([PYTHON_BIN, PDF2JOHN_PATH, target_pdf], capture_output=True, text=True)
        if not result.stdout or "$pdf$" not in result.stdout:
            print_error("ãƒãƒƒã‚·ãƒ¥æŠ½å‡ºå¤±æ•—ã€‚æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"); sys.exit(1)

        hash_data = result.stdout.split(":", 1)[1].strip() if ":" in result.stdout else result.stdout.strip()
        with open(HASH_FILE, "w") as f: f.write(hash_data)
        print_success("ãƒãƒƒã‚·ãƒ¥æƒ…å ±ã®æŠ½å‡ºã«æˆåŠŸã—ã¾ã—ãŸã€‚")

    except Exception as e:
        print_error(f"æŠ½å‡ºã‚¨ãƒ©ãƒ¼: {e}"); sys.exit(1)

    # 2. ãƒ¢ãƒ¼ãƒ‰è‡ªå‹•åˆ¤å®š
    mode = "10700" if "$pdf$5" in hash_data else "10600" if "$pdf$4" in hash_data else "10500"
    mode_name = "PDF 1.7 Level 8" if mode == "10700" else "PDF 1.7 Level 3" if mode == "10600" else "PDF 1.4-1.6"
    print_success(f"æ¤œå‡ºãƒ¢ãƒ¼ãƒ‰: {mode_name} (Hashcat Mode: {mode})")

    # 3. éå»å±¥æ­´ãƒã‚§ãƒƒã‚¯
    check_cmd = ["hashcat", "-m", mode, HASH_FILE, "--show"]
    res = subprocess.run(check_cmd, capture_output=True, text=True)
    if res.stdout.strip():
        print(f"\n{GREEN}ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼æ—¢ã«è§£ææ¸ˆã¿ã§ã™ã€‚{NC}")
        print(f"{CYAN}ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: {res.stdout.strip().split(':')[-1]}{NC}")
        sys.exit(0)

    # 4. æ”»æ’ƒæ‰‹æ³•ã®é¸æŠ
    print_step("è§£æãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„")
    ans_attack = inquirer.prompt([
        inquirer.List('type', message="ã©ã®æ‰‹æ³•ã§è§£æã—ã¾ã™ã‹ï¼Ÿ",
            choices=[
                ('1. è¾æ›¸æ”»æ’ƒ (RockYou.txt - ä¸€èˆ¬çš„)', 'dict'),
                ('2. ãƒã‚¹ã‚¯æ”»æ’ƒ (ãƒ‘ã‚¿ãƒ¼ãƒ³æŒ‡å®š - é«˜é€Ÿ)', 'mask'),
                ('3. ç·å½“ãŸã‚Šæ”»æ’ƒ (æ–‡å­—ç¨®ã¨æ¡æ•°ã‚’æŒ‡å®š)', 'brute'),
            ],
            carousel=True)
    ])
    if not ans_attack: sys.exit()

    execution_queue = []
    base_cmd = ["hashcat", "-m", mode, "-d", "1", "-w", "3", "-O"]

    # --- è¾æ›¸æ”»æ’ƒ ---
    if ans_attack['type'] == 'dict':
        if not os.path.exists(WORDLIST_PATH):
            print_error(f"è¾æ›¸ãªã—: {WORDLIST_PATH}"); sys.exit(1)

        ans_dict = inquirer.prompt([
            inquirer.List('mode', message="è¾æ›¸æ”»æ’ƒã®ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„",
                choices=[
                    ('æ¨™æº– (è¾æ›¸ã®ã¿ - é«˜é€Ÿ)', 'std'),
                    ('Best66ãƒ«ãƒ¼ãƒ« (è¾æ›¸ + ã‚ˆãã‚ã‚‹å¤‰å½¢ - å¼·åŠ›)', 'rule'),
                    ('è‡ªå‹•ã‚¹ãƒ†ãƒƒãƒ—ã‚¢ãƒƒãƒ— (æ¨™æº–ã§è©¦ã—ã¦ãƒ€ãƒ¡ãªã‚‰Best66ã‚’å®Ÿè¡Œ)', 'auto'),
                ], carousel=True)
        ])
        if not ans_dict: sys.exit()

        rule_path = get_rule_path()
        cmd_std = base_cmd + ["-a", "0", HASH_FILE, WORDLIST_PATH]
        cmd_rule = base_cmd + ["-a", "0", "-r", rule_path, HASH_FILE, WORDLIST_PATH] if rule_path else []

        if ans_dict['mode'] == 'std':
            execution_queue.append(("è¾æ›¸æ”»æ’ƒ (æ¨™æº–)", cmd_std))
        elif ans_dict['mode'] == 'rule':
            if not rule_path: print_error("ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ¨™æº–ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚")
            execution_queue.append(("è¾æ›¸æ”»æ’ƒ (ãƒ«ãƒ¼ãƒ«)", cmd_rule if rule_path else cmd_std))
        else: # auto
            execution_queue.append(("Step 1: è¾æ›¸æ”»æ’ƒ (æ¨™æº–)", cmd_std))
            if rule_path:
                execution_queue.append(("Step 2: è¾æ›¸æ”»æ’ƒ (Best66ãƒ«ãƒ¼ãƒ«)", cmd_rule))
            else:
                print_warning("ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ãŸã‚Step 2ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚")

    # --- ãƒã‚¹ã‚¯æ”»æ’ƒ (ä¿®æ­£: inputã‚’ä½¿ç”¨) ---
    elif ans_attack['type'] == 'mask':
        prompt = "ãƒã‚¹ã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å…¥åŠ› (ä¾‹: pass?d?d?d)\n    å‡¡ä¾‹: ?d=æ•°å­—, ?l=å°, ?u=å¤§, ?s=è¨˜å·\n  >"
        val = safe_input(prompt)
        execution_queue.append(("ãƒã‚¹ã‚¯æ”»æ’ƒ", base_cmd + ["-a", "3", HASH_FILE, val]))

    # --- ç·å½“ãŸã‚Šæ”»æ’ƒ (ä¿®æ­£: inputã‚’ä½¿ç”¨) ---
    elif ans_attack['type'] == 'brute':
        ans_charset = inquirer.prompt([
            inquirer.List('type', message="ä½¿ç”¨ã™ã‚‹æ–‡å­—ã‚»ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„",
                choices=[
                    ('1. æ•°å­—ã®ã¿ [0-9] (æœ€é€Ÿ)', 'digits'),
                    ('2. æ•°å­— + è¨˜å· [0-9, !@#...] (ã‚«ã‚¹ã‚¿ãƒ )', 'numsym'),
                    ('3. è‹±æ•°å­— [a-z, A-Z, 0-9] (ä¸€èˆ¬çš„)', 'alnum'),
                    ('4. å…¨æ–‡å­— [è¨˜å·å«ã‚€ã™ã¹ã¦] (?a) (â€»éå¸¸ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)', 'all'),
                ], carousel=True)
        ])
        if not ans_charset: sys.exit()

        # ãƒ’ãƒ³ãƒˆã®è¡¨ç¤º
        hint = {'digits': '12æ¡ä»¥ä¸ŠOK', 'numsym': '8~10æ¡æ¨å¥¨', 'alnum': '7~9æ¡æ¨å¥¨', 'all': '6æ¡ä»¥å†…ã‚’æ¨å¥¨'}[ans_charset['type']]
        
        # æ¡æ•°å…¥åŠ› (inputã‚’ä½¿ç”¨)
        val = safe_input(f"æ¡æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (M4ç›®å®‰: {hint})\n  >", validator=check_digits)
        target_len = val
        
        # å…¥åŠ›ã•ã‚ŒãŸæ¡æ•°ã‚’ä½¿ã£ã¦æ¬¡ã®é¸æŠè‚¢ã‚’ä½œã‚‹
        ans_mode = inquirer.prompt([
            inquirer.List('mode', message="å®Ÿè¡Œç¯„å›²ã‚’é¸æŠã—ã¦ãã ã•ã„",
                choices=[
                    (f'å›ºå®šæ¡æ•°ã®ã¿ ({target_len}æ¡ã®ã¿è©¦ã™ - é«˜é€Ÿ)', 'fixed'),
                    (f'ç¯„å›²å®Ÿè¡Œ (1æ¡ã€œ{target_len}æ¡ã¾ã§å…¨ã¦è©¦ã™)', 'increment'),
                ], carousel=True)
        ])
        if not ans_mode: sys.exit()

        mask_char = {'digits': '?d', 'all': '?a', 'numsym': '?1', 'alnum': '?1'}[ans_charset['type']]
        extra = ["-1", "?d?s"] if ans_charset['type'] == 'numsym' else ["-1", "?d?l?u"] if ans_charset['type'] == 'alnum' else []
        
        # ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼è¨ˆç®—ã¨é˜²æ­¢
        charset_size = {'digits': 10, 'numsym': 42, 'alnum': 62, 'all': 95}[ans_charset['type']]
        keyspace = math.pow(charset_size, int(target_len))
        if keyspace > math.pow(2, 63):
             print_error(f"çµ„ã¿åˆã‚ã›æ•°ãŒå¤šã™ãã¾ã™ ({keyspace:.1e})ã€‚HashcatãŒåœæ­¢ã™ã‚‹ãŸã‚æ¡æ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚")
             sys.exit(1)

        cmd = base_cmd + extra + ["-a", "3", HASH_FILE, mask_char * int(target_len)]
        if ans_mode['mode'] == 'increment': cmd.append("--increment")
        execution_queue.append((f"ç·å½“ãŸã‚Š ({target_len}æ¡ / {ans_charset['type']})", cmd))

    # 5. å®Ÿè¡Œå‡¦ç†
    print("\n" + "="*60)
    print(f"{GREEN}   è§£æãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™{NC}")
    print(f"{YELLOW}   [s]é€²æ—ç¢ºèª  [p]ä¸€æ™‚åœæ­¢  [r]å†é–‹  [q]ä¸­æ–­{NC}")
    print("="*60)

    for i, (desc, cmd) in enumerate(execution_queue, 1):
        print(f"\n{CYAN}[{i}/{len(execution_queue)}] {desc} ã‚’å®Ÿè¡Œä¸­...{NC}")
        subprocess.call(cmd)
        
        res = subprocess.run(check_cmd, capture_output=True, text=True)
        if res.stdout.strip():
            pw = res.stdout.strip().split(':')[-1]
            print("\n" + "="*40)
            print(f"{GREEN}ğŸ‰ è§£ææˆåŠŸï¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼š{NC}")
            print(f"{CYAN}\033[1m   {pw}   \033[0m")
            print("="*40)
            break
    else:
        print(f"\n{RED}æ®‹å¿µãªãŒã‚‰ã€ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚{NC}")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{YELLOW}ä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚çµ‚äº†ã—ã¾ã™ã€‚{NC}")