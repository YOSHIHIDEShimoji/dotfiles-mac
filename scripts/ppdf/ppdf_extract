#!/bin/bash

usage() {
    cat << EOF
Usage: $(basename "$0") [-o OUTPUT.pdf] [-n] INPUT.pdf extra.txt

PDFから特定のページを抽出します。

Arguments:
  INPUT.pdf       元のPDF
  extra.txt       ページ番号リストが書かれたテキストファイル
                  (カンマ、スペース、改行区切りに対応)
                  例: 1, 3, 5-10[odd], 20-30[even], 40[rotate=90], r3-z

Examples in extra.txt:
  1, 3, 5-10      基本的な抽出
  1-z             全ページ (1から最後(z)まで)
  z-1             全ページを逆順で抽出 (最後から1まで)
  r3-z            最後から3番目から最後まで
  1-10[odd]       1〜10ページの奇数のみ
  z[rotate=90]    最終ページを90度回転して抽出

Options:
  -h, --help      このヘルプを表示
  -o OUTPUT.pdf   出力ファイル名を指定 (デフォルト: [元ファイル名]_extracted.pdf)
  -n, --no-sort   ソートと重複削除を無効にする（リストの順序通りに抽出）
EOF
    exit 0
}

OUTPUT=""
NO_SORT=false
FILES=()

# オプション解析
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -o|--output) OUTPUT="$2"; shift 2 ;;
        -n|--no-sort) NO_SORT=true; shift ;;
        -*) echo "Error: 不明なオプション $1"; usage ;;
        *) FILES+=("$1"); shift ;;
    esac
done

set -- "${FILES[@]}"
if [[ $# -ne 2 ]]; then usage; fi

INPUT_PDF="$1"
LIST_FILE="$2"

if [[ ! -f "$INPUT_PDF" || ! -f "$LIST_FILE" ]]; then
    echo "Error: ファイルが見つかりません。"; exit 1
fi

[ -z "$OUTPUT" ] && OUTPUT="${INPUT_PDF%.*}_extracted.pdf"

# 1. テキストファイルのパース ([] を : に変換、区切り文字を正規化)
RAW_PAGES=$(cat "$LIST_FILE" | sed 's/\[/:/g; s/\]//g' | tr '\t\n' '  ' | sed -E 's/[[:space:],]+/,/g' | sed 's/^,//;s/,$//')

if [ -z "$RAW_PAGES" ]; then
    echo "Error: 有効なページ指定がありません。"; exit 1
fi

if [ "$NO_SORT" = true ]; then
    PAGES="$RAW_PAGES"
else
    # 2. ソートと重複削除 (z や r 指定がある場合は sort が正しく機能しない可能性があるため注意)
    PAGES=$(echo "$RAW_PAGES" | tr ',' '\n' | sort -n -k1,1 2>/dev/null | uniq | paste -sd "," -)
    # sortでエラーが出る（zなどが混ざっている）場合は、安全のため元の順序を維持
    [ $? -ne 0 ] && PAGES="$RAW_PAGES"
fi

echo "Extracting: $PAGES"
qpdf "$INPUT_PDF" --pages . "$PAGES" -- "$OUTPUT"
