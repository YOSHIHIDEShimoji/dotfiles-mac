#!/bin/bash

usage() {
    cat << EOF
Usage: $(basename "$0") [-o OUTPUT.pdf] [-n] INPUT.pdf extra.txt

PDFから特定のページを抽出します。

Arguments:
  INPUT.pdf       元のPDF
  extra.txt       ページ番号リスト (カンマ、スペース、改行区切りに対応)
                  例: 1, 3, 5-10, z, r3-z

Options:
  -h, --help      このヘルプを表示
  -o OUTPUT.pdf   出力ファイル名を指定
  -n, --no-sort   ソートと重複削除を無効にする
                  (z, r を含む場合は自動的に無効になります)
EOF
    exit 0
}

OUTPUT=""
NO_SORT=false
FILES=()

# オプション解析
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -o|--output) OUTPUT="$2"; shift 2 ;;
        -n|--no-sort) NO_SORT=true; shift ;;
        -*) echo "Error: 不明なオプション $1"; usage ;;
        *) FILES+=("$1"); shift ;;
    esac
done

set -- "${FILES[@]}"
if [[ $# -ne 2 ]]; then usage; fi

INPUT_PDF="$1"
LIST_FILE="$2"

if [[ ! -f "$INPUT_PDF" || ! -f "$LIST_FILE" ]]; then
    echo "Error: ファイルが見つかりません。"; exit 1
fi

[ -z "$OUTPUT" ] && OUTPUT="${INPUT_PDF%.*}_extracted.pdf"

# --- パース処理 (シンプル版) ---
# 1. [ ] で囲まれた部分をすべて削除 (機能削除のため)
# 2. タブ、改行、スペースをすべてカンマに変換
# 3. 連続するカンマを1つにまとめる
RAW_PAGES=$(cat "$LIST_FILE" \
    | sed 's/\[[^]]*\]//g' \
    | tr '\t\n ' ',,,' \
    | sed -E 's/,+/,/g' \
    | sed 's/^,//;s/,$//')

if [ -z "$RAW_PAGES" ]; then
    echo "Error: 有効なページ指定がありません。"; exit 1
fi

# z または r が含まれていたらソートを強制無効化
if [[ "$RAW_PAGES" =~ [zr] ]]; then
    if [ "$NO_SORT" = false ]; then
        echo "Note: 'z' or 'r' detected. Disabling auto-sort."
        NO_SORT=true
    fi
fi

if [ "$NO_SORT" = true ]; then
    PAGES="$RAW_PAGES"
else
    # ソート処理 (カンマ区切り -> 改行 -> ソート -> カンマ結合)
    PAGES=$(echo "$RAW_PAGES" | tr ',' '\n' | sort -n -k1,1 2>/dev/null | uniq | paste -sd "," -)
fi

echo "Extracting: $PAGES"

# 実行
qpdf "$INPUT_PDF" --pages . "$PAGES" -- "$OUTPUT" && echo "Done! -> $OUTPUT"