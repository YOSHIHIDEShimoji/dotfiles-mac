#!/bin/bash

usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS] FILE.pdf [FILE.pdf ...]

PDFの制限を解除・クリーニングして、ファイルを置き換えます。
元ファイルは /tmp ディレクトリに "_original" 付きで退避されます。

optional arguments:
  -h, --help           このヘルプを表示
  -o, --output-dir DIR 指定したディレクトリに保存 (元ファイルは移動せず残ります)
EOF
    exit 0
}

OUTPUT_DIR=""
FILES=()

# オプション解析 (-i を削除)
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        -h|--help) usage ;;
        -o|--output-dir) 
            if [[ -n "$2" && "$2" != -* ]]; then
                OUTPUT_DIR="$2"; shift 2
            else
                echo "Error: -o にはディレクトリ名が必要です"; exit 1
            fi ;;
        -*) echo "Error: 不明なオプション $1"; usage ;;
        *) FILES+=("$1"); shift ;;
    esac
done

set -- "${FILES[@]}"
if [[ $# -eq 0 ]]; then usage; fi

# 出力ディレクトリ作成
[ -n "$OUTPUT_DIR" ] && mkdir -p "$OUTPUT_DIR"

# qpdfの共通オプション
QPDF_OPTS="--decrypt --object-streams=disable --stream-data=uncompress"

for file in "$@"; do
    [[ ! -f "$file" ]] && { echo "Skip: $file"; continue; }
    
    base=$(basename "$file")
    
    if [ -n "$OUTPUT_DIR" ]; then
        # パターンA: 出力先指定あり (-o 使用時)
        # 元ファイルはいじらず、指定先に新しいファイルを作る
        output="$OUTPUT_DIR/$base"
        echo -n "Processing to dir: $file -> $output ... "
        qpdf $QPDF_OPTS "$file" "$output" 2>/dev/null && echo "Done!" || echo "Failed."
        
    else
        # パターンB: デフォルト動作 (カレントディレクトリで置換)
        # 1. バックアップパスの生成 (/tmp/filename_original.pdf)
        filename="${base%.*}"
        extension="${base##*.}"
        backup_name="${filename}_original.${extension}"
        backup_path="/tmp/${backup_name}"

        echo -n "Processing: $file (Backup: $backup_path) ... "

        # 2. 元ファイルを /tmp に移動 (退避)
        if mv "$file" "$backup_path"; then
            
            # 3. qpdf実行 (入力: バックアップ -> 出力: 元のファイル名)
            if qpdf $QPDF_OPTS "$backup_path" "$file" 2>/dev/null; then
                echo "Done!"
            else
                echo "Failed!"
                # 失敗時はバックアップから書き戻す (救済措置)
                echo "  -> Error occurred. Restoring original file..."
                mv "$backup_path" "$file"
            fi
        else
            echo "Error: Failed to move file to /tmp. Skipped."
        fi
    fi
done