#!/usr/bin/env bash
set -euo pipefail

# オプション解析
DO_PUSH=false
SKIP_CONFIRM=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    -p) DO_PUSH=true ;;
    -y) SKIP_CONFIRM=true ;;
    *) echo "Usage: $(basename "$0") [-p] [-y]" >&2; exit 1 ;;
  esac
  shift
done

# staged changesがあるか確認
if [[ -z "$(git diff --cached --name-only)" ]]; then
  echo "Error: No staged changes. Use 'git add' first." >&2
  exit 1
fi

# diffを取得
diff=$(git diff --cached)

if [[ -z "$diff" ]]; then
  echo "Error: Staged changes are empty." >&2
  exit 1
fi

# Claude Codeにコミットメッセージを生成してもらう
BASE_PROMPT=$'このgit diffの内容を見て、適切なコミットメッセージを日本語で1行で書いてください。メッセージだけを出力して、説明や補足は一切不要です。'

build_prompt() {
  local extra_request="$1"
  if [[ -n "$extra_request" ]]; then
    printf '%s\n\nユーザーからの追加リクエスト: %s\n' "$BASE_PROMPT" "$extra_request"
  else
    printf '%s\n' "$BASE_PROMPT"
  fi
}

generate_commit_msg() {
  local extra_request="${1:-}"
  local prompt
  prompt=$(build_prompt "$extra_request")
  local msg
  msg=$(echo "$diff" | claude -p "$prompt")
  msg=${msg//$'\r'/}
  if [[ -z "$msg" ]]; then
    echo "Error: Failed to generate commit message." >&2
    exit 1
  fi
  printf '%s' "$msg"
}

commit_msg=$(generate_commit_msg)

# 確認
if [[ "$SKIP_CONFIRM" == false ]]; then
  while true; do
    echo "Commit message: $commit_msg"
    read -rp "Proceed? [y/N]: " answer
    case "$answer" in
      [yY])
        break
        ;;
      [nN])
        if ! read -rp "Claudeにどう調整してほしいか入力してください: " feedback; then
          echo "Aborted."
          exit 1
        fi
        if [[ -z "$feedback" ]]; then
          echo "フィードバックが空です。"
          continue
        fi
        commit_msg=$(generate_commit_msg "$feedback")
        ;;
      *)
        echo "Aborted."
        exit 0
        ;;
    esac
  done
fi

# コミット実行
git commit -m "$commit_msg"

# pushオプションが指定されていればpush
if [[ "$DO_PUSH" == true ]]; then
  git push
fi
