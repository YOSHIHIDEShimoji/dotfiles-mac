#!/usr/bin/env bash
set -euo pipefail

DOTFILES="${DOTFILES:-$HOME/dotfiles-mac}"

brewfile="$DOTFILES/install/Brewfile"
extfile="$DOTFILES/vscode/extensions.txt"

mkdir -p "$(dirname "$brewfile")" "$(dirname "$extfile")"

if command -v brew >/dev/null 2>&1; then
  tmp="$(mktemp)"
  brew bundle dump --force --file=- | grep -v '^vscode' > "$tmp"
  mv "$tmp" "$brewfile"
fi

if command -v code >/dev/null 2>&1; then
  tmp="$(mktemp)"
  if code --list-extensions > "$tmp"; then
    mv "$tmp" "$extfile"
  else
    rm -f "$tmp"
  fi
fi

cd "$DOTFILES"
if [[ -n "$(git status --porcelain)" ]]; then
  git status -s
  git add "$brewfile" "$extfile"
  git commit -m "Update Brewfile and VSCode extensions"
  echo "Changes committed."
else
  echo "No changes."
fi